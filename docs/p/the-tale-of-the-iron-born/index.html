<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='COQ'><title>The tale of the Iron Born</title>

<link rel='canonical' href='https://distributed-randomness.github.io/p/the-tale-of-the-iron-born/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='The tale of the Iron Born'>
<meta property='og:description' content='COQ'>
<meta property='og:url' content='https://distributed-randomness.github.io/p/the-tale-of-the-iron-born/'>
<meta property='og:site_name' content='Distributed Randomness'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='distributed-systems' /><meta property='article:tag' content='verification' /><meta property='article:published_time' content='2021-10-12T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2021-10-12T00:00:00&#43;00:00'/><meta property='og:image' content='https://distributed-randomness.github.io/p/the-tale-of-the-iron-born/yellow_swirl.jpg' />
<meta name="twitter:title" content="The tale of the Iron Born">
<meta name="twitter:description" content="COQ"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://distributed-randomness.github.io/p/the-tale-of-the-iron-born/yellow_swirl.jpg' />
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="https://distributed-randomness.github.io/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>Back</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/the-tale-of-the-iron-born/">
                <img src="/p/the-tale-of-the-iron-born/yellow_swirl_hu3b2749d1cdf724aabc7cbad8108c554b_6067644_800x0_resize_q75_box.jpg"
                        srcset="/p/the-tale-of-the-iron-born/yellow_swirl_hu3b2749d1cdf724aabc7cbad8108c554b_6067644_800x0_resize_q75_box.jpg 800w, /p/the-tale-of-the-iron-born/yellow_swirl_hu3b2749d1cdf724aabc7cbad8108c554b_6067644_1600x0_resize_q75_box.jpg 1600w"
                        width="800" 
                        height="769" 
                        loading="lazy"
                        alt="Featured image of post The tale of the Iron Born" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <h2 class="article-title">
        <a href="/p/the-tale-of-the-iron-born/">The tale of the Iron Born</a>
    </h2>

    
    <h3 class="article-subtitle">
        COQ
    </h3>
    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 12, 2021</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    7 minute read
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p>A distributed system is a coordonated group of machines working towards a common objective but to the end use it appears as if they are tallking to a single machine. The common objective can be the utility and the gurantees the system provides such as database, or a stream processor, a batch processing systems. The true complexity of a distributed system design lies in abstracting out the fact that a client is talking to multiple servers behind the scene and not just one of them. If proper care is taken in how you choose these machines (not sharing the same data-centre rack or even building) carefully, a distributed system can be more highly available than a single machine system. High availbaility comes from having multiple copies of the data and in which case if a machine fails you can get the  data from other machines and this must happen transparently for the client. Now, if any replica is capable if serving the requested data, then they must all have the latest version of the data. This is the core of the problem, keeping all copies of the data consistent in face of machine failures or network partitions.</p>
<p>Putting the problem simply, a distributed systems designer has to wrestle with these four questions - how to deal with writes, which machine should handle the read, how to detect failures and then how to recover from them. All of these are error prone and therefore we want to have enough confidence in our design. There are a few ways we can do that:</p>
<ol>
<li>Write tests. Util tests and integration tests are a good place to start but they only help us catch issues that we already anticipate.</li>
<li>There are frameworks like <a class="link" href="https://altsysrq.github.io/proptest-book/intro.html"  target="_blank" rel="noopener"
    >proptest</a> that help to test whether certain properties of your code hold for an arbitrary set of input and if the code fails, the framework provides a counter-example to the hypothesis. This is great but does not guarantee that it will find all the faliure scenarios.</li>
<li>We can subject our system to <a class="link" href="https://jepsen.io/analyses"  target="_blank" rel="noopener"
    >Jepsen Analysis</a> or their new tool Elle[2]. This generates the system traces and then does an analysis for <a class="link" href="https://jepsen.io/consistency"  target="_blank" rel="noopener"
    >database consistency</a> violations. This is quite rigorous but again, does not gurantee all the edge cases will be explored.</li>
<li>Exernal fault injection with frameworks such as <a class="link" href="https://netflix.github.io/chaosmonkey/"  target="_blank" rel="noopener"
    >Chaos Monkey</a>.</li>
<li>Have exhaustive logs, metrics and traces (the three pillars of Observability). This helps you catch bugs after the fact but does not prevent the occurrence of it. It is also based on the premise that we have sufficient logging enabled around the failure path.</li>
<li>Write a simulator for your system before doinf the actual implementation as the <a class="link" href="https://www.youtube.com/watch?v=4fFDFbi3toc"  target="_blank" rel="noopener"
    >FoundationDB folks did</a>.</li>
<li>Formal methods based on model checking (exhaustively exploring the state space) or formal verification can generate machine checked proof of the system spec but its very hard to generate the full specification of a system. Systems are complex and they evolve with new features. Its tedious to keep the spec up to date. Another problem is that the spec is maintained separately from the code.</li>
</ol>
<p>Although the above points might be disheartening, we would still like to write correct distributed systems. And there are ways we can do it. As IronFleet[1] established, it is possible to verify a complex <a class="link" href="https://lamport.azurewebsites.net/pubs/lamport-paxos.pdf"  target="_blank" rel="noopener"
    >paxos</a>-based <a class="link" href="https://en.wikipedia.org/wiki/State_machine_replication"  target="_blank" rel="noopener"
    >Replicaed State Machine</a> and use it to implement a shared Key/value store. When you read the paper you realize that one of the hardest part might have been to come up with the invariants in the</p>
<h2 id="writing-a-system-specification">Writing a system Specification</h2>
<p>As Butler Lampson writes in <a class="link" href="https://www.microsoft.com/en-us/research/uploads/prod/2019/09/Hints-and-Principles-v1-full.pdf"  target="_blank" rel="noopener"
    >this paper</a>, the writing of a correct system should always begin at the Specification. There are tools that can help you write one such as $TLA^+$ that can reason about <a class="link" href="https://link.springer.com/chapter/10.1007/978-3-319-10575-8_2"  target="_blank" rel="noopener"
    >Temperal Logic</a> and proof assistants such as <a class="link" href="https://github.com/coq/coq"  target="_blank" rel="noopener"
    >Coq</a>. The problem with this approach is that the spec and the code are maintained separately and the spec is only for documentation only. Writing a correct spec does not gurantee a correct implementation as there is no system that validates the implementaiton against the proof of correctness. Think of this like a compiler for a language. I compiler writer decides the syntax of the language and then writes a compiler that accepts programs within the bounds of what the language specification allows. The compiler usually does it in a hands-free manner but there are cases where the programmer needs to lead the compiler by hand such as when we have to specify the lifetimes in a rust program explicitly.</p>
<p>In case of distributed system spec, we want to provide the designer the freedom to come up with the rules of the system. This is important, because we want our spec writing framework to be used with a wide variety of systems and not just one. There are verifiers such as <a class="link" href="https://dafny-lang.github.io/dafny/"  target="_blank" rel="noopener"
    >Dafny</a> and <a class="link" href="https://viperproject.github.io/prusti-dev/user-guide/intro.html"  target="_blank" rel="noopener"
    >Prusti</a> that takes specifications as code annotations sprinkled over functions as pre and post conditions. This is consistent wiith the <a class="link" href="https://en.wikipedia.org/wiki/Hoare_logic"  target="_blank" rel="noopener"
    >Floyd-Hoare Logic</a> which talks about a $3-tuple$ ${P}$C${Q}$ where P and Q are assertions also called the pre-condition (restrictions on input written as assertions in predicate logic) and post-conditions (restrictions on output also described as assertions in predicate logic) and $C$ is the command to be executed when the pre-conditions are met generating values consistent with the post-conditions. It is important for the spec to be contained in a module of its own. Having it sprinkled all over can make it hard to read in a large codebase of several million lines which is a commonplace for distributed systems. I would like to think of the spec to be written in a custom DSL in a few <code>.spec</code> files. In <code>Rust</code> lingo, the spec should be in a separate crate and building a spec should generate dummy top level Protocol stubs with annotations for pre and post conditions.</p>
<h3 id="verifying-the-spec">Verifying the Spec</h3>
<p>The spec format should be very close to <code>Rust</code> format but it should be expressive enough for people to encode the proof Hypothesis and the goal. The goal of a verification tool is given this situation, prove that the constraint holds for all input values and if they don&rsquo;t, then provide a counter example. And then the spec author can tune the invariants and put it up for another round of evaluation against the verification tool and this is repeated.</p>
<p>The <a class="link" href="https://ocamlpro.github.io/verification_for_dummies/mikino_bmc/index.html"  target="_blank" rel="noopener"
    >Mikino Bounded Model Checker</a> does a great job is staying close to Rust Syntax.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="c1">// The scenario models a stop-watch with a toggle button which can be 
</span><span class="c1"></span><span class="sd">/// pressed to toggle between start and stop. Whether the stop-watch is 
</span><span class="sd">/// in counting mode or stopped is indicated by the is_counting state 
</span><span class="sd">/// variable. And the value of the counter is provided by the counter. 
</span><span class="sd">/// Reset button sets the counter to 0.
</span><span class="sd"></span><span class="w">
</span><span class="w"></span><span class="sd">/// State variables.
</span><span class="sd"></span><span class="n">svars</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="sd">/// Inputs of the system.
</span><span class="sd"></span><span class="w">    </span><span class="n">start_stop</span><span class="w"> </span><span class="n">reset</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="sd">/// Keeps track of whether we are counting.
</span><span class="sd"></span><span class="w">    </span><span class="n">is_counting</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="sd">/// Counts time, output of the system.
</span><span class="sd"></span><span class="w">    </span><span class="n">cnt</span>: <span class="nc">int</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="sd">/// Initial state of the system.
</span><span class="sd"></span><span class="n">init</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">is_counting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_stop</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">cnt</span><span class="w"> </span><span class="err">≥</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="p">(</span><span class="n">reset</span><span class="w"> </span><span class="err">⇒</span><span class="w"> </span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="sd">/// Transition relation.
</span><span class="sd"></span><span class="n">trans</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="c1">// The *next* value of `is_counting` is equal to...
</span><span class="c1"></span><span class="w">    </span><span class="na">&#39;is_counting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="na">&#39;start_stop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="c1">// ...if `&#39;start_stop` is true, then the negation of
</span><span class="c1"></span><span class="w">        </span><span class="c1">// its *previous* value...
</span><span class="c1"></span><span class="w">        </span><span class="err">¬</span><span class="n">is_counting</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="c1">// ...otherwise, it is equal to its previous value.
</span><span class="c1"></span><span class="w">        </span><span class="n">is_counting</span><span class="w">
</span><span class="w">    </span><span class="p">},</span><span class="w">
</span><span class="w">    </span><span class="na">&#39;cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="na">&#39;reset</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="mi">0</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="na">&#39;is_counting</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">cnt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">cnt</span><span class="w">
</span><span class="w">    </span><span class="p">},</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="sd">/// State invariants.
</span><span class="sd"></span><span class="n">candidates</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="s">&#34;cnt is positive&#34;</span>: <span class="nc">cnt</span><span class="w"> </span><span class="err">≥</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="s">&#34;cnt ≤ 2&#34;</span>: <span class="nc">cnt</span><span class="w"> </span><span class="err">≤</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="s">&#34;cnt ≤ 4&#34;</span>: <span class="nc">cnt</span><span class="w"> </span><span class="err">≤</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span></code></pre></div><p>Mikino uses the venerable <a class="link" href="http://theory.stanford.edu/~nikolaj/programmingz3.html"  target="_blank" rel="noopener"
    >Z3 solver</a> to solve for constraints. Ze has a <a class="link" href="https://docs.rs/z3-sys/0.7.1/z3_sys/"  target="_blank" rel="noopener"
    >Rust adapter</a> that can be used here.</p>
<p>Another example is the <a class="link" href="https://github.com/stateright/stateright/blob/master/examples/linearizable-register.rs"  target="_blank" rel="noopener"
    >Stateright</a> which is written in Rust and the Model provided as Rust struct that implements the <code>Actor</code> trait. The following is an example copied from the stateright <a class="link" href="https://github.com/stateright/stateright/blob/master/examples/linearizable-register.rs"  target="_blank" rel="noopener"
    >repo</a> depicting the state transitions in a Linearizable Registers from the paper <a class="link" href="https://doi.org/10.1145/200836.200869"  target="_blank" rel="noopener"
    >Sharing Memory Robustly in Message-Passing Systems</a> by Attiya, Bar-Noy, and Dolev (ABD).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="p">...</span><span class="w">
</span><span class="w"></span><span class="sd">/// State variables to capture of Linearizable 
</span><span class="sd"></span><span class="cp">#[derive(Clone, Debug, Eq, Hash, PartialEq)]</span><span class="w">
</span><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">AbdState</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">seq</span>: <span class="nc">Seq</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">val</span>: <span class="nc">Value</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">phase</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">AbdPhase</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">...</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Actor</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AbdActor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">type</span> <span class="nc">Msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RegisterMsg</span><span class="o">&lt;</span><span class="n">RequestId</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">AbdMsg</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">type</span> <span class="nc">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AbdState</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">  	</span><span class="sd">/// Initial state
</span><span class="sd"></span><span class="w">    </span><span class="k">fn</span> <span class="nf">on_start</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">id</span>: <span class="nc">Id</span><span class="p">,</span><span class="w"> </span><span class="n">_o</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Out</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">State</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">AbdState</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">seq</span>: <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">),</span><span class="w">
</span><span class="w">            </span><span class="n">val</span>: <span class="nc">Value</span>::<span class="n">default</span><span class="p">(),</span><span class="w">
</span><span class="w">            </span><span class="n">phase</span>: <span class="nb">None</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">  	</span><span class="sd">/// State transition on receiving messages.
</span><span class="sd"></span><span class="w">    </span><span class="k">fn</span> <span class="nf">on_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">id</span>: <span class="nc">Id</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Cow</span><span class="o">&lt;</span><span class="n">Self</span>::<span class="n">State</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">src</span>: <span class="nc">Id</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="nc">Self</span>::<span class="n">Msg</span><span class="p">,</span><span class="w"> </span><span class="n">o</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Out</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">Put</span><span class="p">(</span><span class="n">req_id</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">phase</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="n">o</span><span class="p">.</span><span class="n">broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">peers</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Internal</span><span class="p">(</span><span class="n">Query</span><span class="p">(</span><span class="n">req_id</span><span class="p">)));</span><span class="w">
</span><span class="w">                </span><span class="n">state</span><span class="p">.</span><span class="n">to_mut</span><span class="p">().</span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">AbdPhase</span>::<span class="n">Phase1</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                    </span><span class="n">request_id</span>: <span class="nc">req_id</span><span class="p">,</span><span class="w">
</span><span class="w">                    </span><span class="n">requester_id</span>: <span class="nc">src</span><span class="p">,</span><span class="w">
</span><span class="w">                    </span><span class="n">write</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="w">
</span><span class="w">                    </span><span class="n">responses</span>: <span class="p">{</span><span class="w">
</span><span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashableHashMap</span>::<span class="n">default</span><span class="p">();</span><span class="w">
</span><span class="w">                        </span><span class="n">responses</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">seq</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">clone</span><span class="p">()));</span><span class="w">
</span><span class="w">                        </span><span class="n">responses</span><span class="w">
</span><span class="w">                    </span><span class="p">},</span><span class="w">
</span><span class="w">                </span><span class="p">});</span><span class="w">
</span><span class="w">            </span><span class="p">}</span><span class="w">
</span><span class="w">            </span><span class="n">Get</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">phase</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="n">o</span><span class="p">.</span><span class="n">broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">peers</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Internal</span><span class="p">(</span><span class="n">Query</span><span class="p">(</span><span class="n">req_id</span><span class="p">)));</span><span class="w">
</span><span class="w">                </span><span class="n">state</span><span class="p">.</span><span class="n">to_mut</span><span class="p">().</span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">AbdPhase</span>::<span class="n">Phase1</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                    </span><span class="n">request_id</span>: <span class="nc">req_id</span><span class="p">,</span><span class="w">
</span><span class="w">                    </span><span class="n">requester_id</span>: <span class="nc">src</span><span class="p">,</span><span class="w">
</span><span class="w">                    </span><span class="n">write</span>: <span class="nb">None</span><span class="p">,</span><span class="w">
</span><span class="w">                    </span><span class="n">responses</span>: <span class="p">{</span><span class="w">
</span><span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashableHashMap</span>::<span class="n">default</span><span class="p">();</span><span class="w">
</span><span class="w">                        </span><span class="n">responses</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">seq</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">clone</span><span class="p">()));</span><span class="w">
</span><span class="w">                        </span><span class="n">responses</span><span class="w">
</span><span class="w">                    </span><span class="p">},</span><span class="w">
</span><span class="w">                </span><span class="p">});</span><span class="w">
</span><span class="w">            </span><span class="p">}</span><span class="w">
</span><span class="w">          
</span><span class="w"></span><span class="p">...</span><span class="w">    
</span></code></pre></div><p>Stateright does not verify the Model or any arbitrary but acceptable input but it can validate the a trace for you. This is closer to how Jepsen works. You run a workload against the system and capture the trace and then you pass the trace to your checker and it can tell you if there is a possible falsification of the claimed consistency level of the system. But as one might guess, this method validates only the given trace and not all possible traces.</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 248; 
			flex-basis: 595px"
	>
	<a href="/p/the-tale-of-the-iron-born/workflow.png" data-size="2522x1016">
		<img src="/p/the-tale-of-the-iron-born/workflow.png"
			width="2522"
			height="1016"
			srcset="/p/the-tale-of-the-iron-born/workflow_hu9523102adb828af7fa312870f1149ae8_328952_480x0_resize_box_3.png 480w, /p/the-tale-of-the-iron-born/workflow_hu9523102adb828af7fa312870f1149ae8_328952_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="The flow from I4[5]">
	</a>
	
	<figcaption>The flow from I4[5]</figcaption>
	
</figure></p>
<p><em>The state invariants are the hardest thing ting to get right and in the workflow depicted above from the  I4 paper[5] shows a way.</em></p>
<h2 id="levels-of-refinements">Levels Of Refinements</h2>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 185; 
			flex-basis: 446px"
	>
	<a href="/p/the-tale-of-the-iron-born/refinement.png" data-size="952x512">
		<img src="/p/the-tale-of-the-iron-born/refinement.png"
			width="952"
			height="512"
			srcset="/p/the-tale-of-the-iron-born/refinement_hu6e591135b3889affe1073dd9a0142650_114223_480x0_resize_box_3.png 480w, /p/the-tale-of-the-iron-born/refinement_hu6e591135b3889affe1073dd9a0142650_114223_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="Screen Shot 2021-10-10 at 8.56.54 PM">
	</a>
	
	<figcaption>Screen Shot 2021-10-10 at 8.56.54 PM</figcaption>
	
</figure></p>
<hr>
<h2 id="references">References</h2>
<ol>
<li>
<p><a class="link" href="https://www.microsoft.com/en-us/research/wp-content/uploads/2015/10/ironfleet.pdf"  target="_blank" rel="noopener"
    >IronFleet, SOSP' 2015</a></p>
</li>
<li>
<p><a class="link" href="https://www.vldb.org/pvldb/vol14/p268-alvaro.pdf"  target="_blank" rel="noopener"
    >Elle, VLDB 2021</a></p>
</li>
<li>
<p><a class="link" href="https://people.ucsc.edu/~palvaro/molly.pdf"  target="_blank" rel="noopener"
    >Lineage Dtiven Fault Injection, SIGMOD 2015</a></p>
</li>
<li>
<p><a class="link" href="https://link.springer.com/book/10.1007/978-3-319-10575-8"  target="_blank" rel="noopener"
    >HandBook Of Model Checking</a>.</p>
</li>
<li>
<p><a class="link" href="https://6826.csail.mit.edu/2020/papers/i4.pdf"  target="_blank" rel="noopener"
    >I4, SOSP 2019</a>.</p>
</li>
<li>
<p><a class="link" href="https://homes.cs.washington.edu/~ztatlock/pubs/verdi-wilcox-pldi15.pdf"  target="_blank" rel="noopener"
    >Verdi, PLDI 2015</a>.</p>
</li>
<li>
<p><a class="link" href="https://cs.stanford.edu/~padon/ivy.pdf"  target="_blank" rel="noopener"
    >Ivy</a>.</p>
</li>
<li>
<p><a class="link" href="https://www.microsoft.com/en-us/research/uploads/prod/2019/09/Hints-and-Principles-v1-full.pdf"  target="_blank" rel="noopener"
    >Hints and Principles of System Design</a>.</p>
</li>
</ol>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/distributed-systems/">distributed-systems</a>
        
            <a href="/tags/verification/">verification</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    <aside class="related-contents--wrapper">
    
    
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (DISQUS) {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="disclaimer">
        
            Opinions are my own. Please take with a few grains of salt. <br/>
        

    </section>

    <section class="copyright">
        &copy; 
        
        2021 Distributed Randomness
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.2.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">Table of contents</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li><a href="#writing-a-system-specification">Writing a system Specification</a>
      <ol>
        <li><a href="#verifying-the-spec">Verifying the Spec</a></li>
      </ol>
    </li>
    <li><a href="#levels-of-refinements">Levels Of Refinements</a></li>
    <li><a href="#references">References</a></li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
